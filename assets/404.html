<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loading...</title>
  <script>
    // GitHub Pages serves this 404.html for non-existent paths.
    // Shinylive creates virtual paths like /repo/app-name/app_xxx/ that should
    // be intercepted by the service worker.
    //
    // Race condition: The main page sends configureProxyPath to the SW, then
    // immediately sets iframe.src = "app_xxx/". If the network request reaches
    // GitHub before the SW processes the registration, GitHub returns this 404.
    //
    // Solution: This page (loaded in the iframe) waits briefly then reloads.
    // By then, the SW should have registered the app path and will intercept
    // the reload request, proxying it correctly.
    
    (function() {
      var path = window.location.pathname;
      
      // Only handle app_xxx paths - these are shinylive virtual routes
      var appPathMatch = path.match(/^(.*)\/([^\/]+)\/(app_[^\/]+)(\/|$)/);
      
      if (!appPathMatch) {
        // Not an app path - show actual 404
        document.body.innerHTML = '<h1>Page Not Found</h1><p>The requested page could not be found.</p><p><a href="/">Return to Home</a></p>';
        return;
      }
      
      // Track reload attempts to prevent infinite loop
      var reloadKey = 'shinylive_404_' + path;
      var reloadCount = parseInt(sessionStorage.getItem(reloadKey) || '0', 10);
      
      if (reloadCount >= 3) {
        // Exhausted retries - clear counter and show error
        sessionStorage.removeItem(reloadKey);
        var appIndexUrl = appPathMatch[1] + '/' + appPathMatch[2] + '/index.html';
        document.body.innerHTML = 
          '<h1>Application Loading Error</h1>' +
          '<p>The Shinylive service worker could not intercept this request.</p>' +
          '<p>This may happen on the first visit. Please try:</p>' +
          '<ol>' +
          '<li><a href="' + appIndexUrl + '">Go to the application page</a></li>' +
          '<li>Wait for it to fully load</li>' +
          '<li>Refresh the page</li>' +
          '</ol>';
        return;
      }
      
      // Increment counter
      sessionStorage.setItem(reloadKey, String(reloadCount + 1));
      
      // Wait a bit for the service worker to register the app path, then reload
      // Increase delay with each retry: 100ms, 200ms, 300ms
      var delay = (reloadCount + 1) * 100;
      
      setTimeout(function() {
        window.location.reload();
      }, delay);
    })();
  </script>
</head>
<body>
  <p>Loading application...</p>
  <noscript>
    <h1>JavaScript Required</h1>
    <p>JavaScript is required to load this application.</p>
  </noscript>
</body>
</html>
