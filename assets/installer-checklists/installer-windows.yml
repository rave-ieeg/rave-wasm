# RAVE Installation Checklist for Windows
# GitHub Actions-style syntax for installation steps

name: RAVE Installation (Windows)

steps:
  # Step 1: Check and install R
  - id: r-language
    name: R Programming Language
    type: shell
    if: |
      @echo off
      setlocal enabledelayedexpansion
      
      REM Check RSTUDIO_WHICH_R environment variable first
      if defined RSTUDIO_WHICH_R (
        if exist "%RSTUDIO_WHICH_R%" exit /b 0
      )
      
      REM Check registry for R installations (64-bit first, then 32-bit)
      for %%K in (HKCU HKLM) do (
        for %%V in (R64 R) do (
          REM Enumerate version subkeys under R-core\R or R-core\R64
          for /f "delims=" %%S in ('reg query "%%K\Software\R-core\%%V" 2^>nul ^| findstr "\\R-core\\%%V\\"') do (
            REM Query InstallPath from the version subkey
            for /f "tokens=2*" %%a in ('reg query "%%S" /v "InstallPath" 2^>nul ^| findstr "InstallPath"') do (
              if exist "%%b\bin\x64\R.exe" exit /b 0
              if exist "%%b\bin\i386\R.exe" exit /b 0
              if exist "%%b\bin\R.exe" exit /b 0
            )
          )
        )
      )
      
      REM Check common installation locations
      for %%D in ("C:\R" "%ProgramFiles%\R" "%ProgramFiles(x86)%\R" "%LOCALAPPDATA%\Programs\R") do (
        if exist "%%~D" (
          for /d %%R in ("%%~D\R-*") do (
            if exist "%%R\bin\x64\R.exe" exit /b 0
            if exist "%%R\bin\i386\R.exe" exit /b 0
            if exist "%%R\bin\R.exe" exit /b 0
          )
        )
      )
      
      exit /b 1
    run: echo "Please download and install R from https://cran.r-project.org/bin/windows/base/"
    required: true
    manualExecute: true
    timeout: 300000  # 5 minutes
    description: R is required to run RAVE
    manualInstructions: |
      Download and install R from:
      https://cran.r-project.org/bin/windows/base/
      
      Follow the installer prompts with default options.

  # Step 1.5: Install pkgbuild package (for Rtools detection)
  - id: pkgbuild
    name: R Package 'pkgbuild'
    type: rscript
    run: |
      if (!require('pkgbuild', quietly = TRUE)) {
        install.packages('pkgbuild', repos = 'https://cloud.r-project.org')
      }
      cat("\npkgbuild package installed\n")
    required: true
    manualExecute: false
    needs: [r-language]
    timeout: 300000  # 5 minutes
    description: Install pkgbuild package to detect Rtools availability
    manualInstructions: |
      Open R or RStudio and run:
      install.packages('pkgbuild')

  # Step 2: Check and install Rtools
  - id: rtools
    name: Rtools for Windows
    type: shell
    if: Rscript -e "pkgbuild::has_build_tools()" 2>nul | findstr TRUE
    run: echo "Please download and install Rtools from https://cran.r-project.org/bin/windows/Rtools/"
    required: true
    manualExecute: true
    timeout: 300000  # 5 minutes
    description: Rtools is required to compile R packages from source
    manualInstructions: |
      Download and install Rtools from:
      https://cran.r-project.org/bin/windows/Rtools/
      
      Choose the version matching your R installation.
      Follow the installer prompts with default options.
      Restart your computer after installation.

  # Step 3: Check and install RStudio (optional)
  - id: rstudio
    name: RStudio IDE
    type: shell
    if: test -f "C:\Program Files\RStudio\rstudio.exe"
    run: echo "Please download and install RStudio from https://posit.co/download/rstudio-desktop/"
    required: false
    manualExecute: true
    timeout: 300000  # 5 minutes
    description: RStudio is recommended for R development but not required for RAVE
    manualInstructions: |
      Download and install RStudio from:
      https://posit.co/download/rstudio-desktop/
      
      Follow the installer prompts with default options.

  # Step 4: Install RAVE packages
  - id: rave-packages
    name: RAVE Packages
    type: rscript
    run: |
      options(repos = c(RAVE = 'https://rave-ieeg.r-universe.dev', CRAN = 'https://cloud.r-project.org'))
      install.packages('ravemanager')
      ravemanager::install()
      cat("\nINSTALLATION_COMPLETE\n")
    required: true
    manualExecute: false
    needs: [r-language, pkgbuild, rtools]
    timeout: 1800000  # 30 minutes
    description: RAVE packages for electrophysiology data analysis
    manualInstructions: |
      Open R or RStudio and run:
      install.packages('ravemanager', repos = 'https://rave-ieeg.r-universe.dev')
      ravemanager::install()
      
      Or follow instructions at:
      https://rave.wiki/posts/installation/installation.html
